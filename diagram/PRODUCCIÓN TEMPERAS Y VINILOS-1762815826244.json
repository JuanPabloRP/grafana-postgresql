{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 0,
  "links": [],
  "panels": [
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 11,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "postgres",
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "ef3qa71ynn6kgc"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  TO_DATE(rp.año || '-' ||\r\n    CASE LOWER(rp.mes)\r\n      WHEN 'enero' THEN '01'\r\n      WHEN 'febrero' THEN '02'\r\n      WHEN 'marzo' THEN '03'\r\n      WHEN 'abril' THEN '04'\r\n      WHEN 'mayo' THEN '05'\r\n      WHEN 'junio' THEN '06'\r\n      WHEN 'julio' THEN '07'\r\n      WHEN 'agosto' THEN '08'\r\n      WHEN 'septiembre' THEN '09'\r\n      WHEN 'octubre' THEN '10'\r\n      WHEN 'noviembre' THEN '11'\r\n      WHEN 'diciembre' THEN '12'\r\n    END || '-01', 'YYYY-MM-DD'\r\n  ) AS \"time\", -- Renombrado a \"time\" como buena práctica para Grafana\r\n  SUM(rp.pacas_producidas) AS total_pacas\r\nFROM RegistrosProduccion AS rp\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario\r\nWHERE\r\n  -- Filtros de máquina y operario con manejo de NULLs\r\n  COALESCE(m.nombre, 'Sin Asignar') IN ($maquina)\r\n  AND COALESCE(o.nombre, 'Sin Asignar') IN ($operario)\r\n  -- Filtro de año robusto (reemplaza tu versión anterior)\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)\r\nGROUP BY rp.año, rp.mes\r\nORDER BY rp.año, \"time\";",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Producción total por mes",
      "type": "timeseries"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 24,
        "x": 0,
        "y": 9
      },
      "id": 6,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "<center>\r\nREGISTRO DE PRODUCCIÓN\r\n</center>",
        "mode": "markdown"
      },
      "pluginVersion": "12.2.1",
      "title": "",
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "green",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 12,
        "x": 0,
        "y": 11
      },
      "id": 4,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "percentChangeColorMode": "standard",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "showPercentChange": false,
        "textMode": "auto",
        "wideLayout": true
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "postgres",
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "ef3qa71ynn6kgc"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  SUM(rp.pacas_producidas) AS total_pacas\r\nFROM registrosproduccion AS rp\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario\r\nWHERE\r\n  COALESCE(m.nombre, 'Sin Asignar') IN ($maquina)\r\n  AND COALESCE(o.nombre, 'Sin Asignar') IN ($operario)\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Producción total de pacas",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "continuous-RdYlGr"
          },
          "mappings": [],
          "max": 100,
          "min": 0,
          "thresholds": {
            "mode": "percentage",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "#6ED0E0",
                "value": ""
              },
              {
                "color": "#EAB839",
                "value": ""
              },
              {
                "color": "red",
                "value": 70
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 6,
        "w": 12,
        "x": 12,
        "y": 11
      },
      "id": 5,
      "options": {
        "minVizHeight": 31,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": true,
        "showThresholdMarkers": true,
        "sizing": "auto",
        "text": {
          "percentSize": 1
        }
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "postgres",
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "ef3qa71ynn6kgc"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  ROUND(\r\n    (SUM(rp.horas_trabajadas) / NULLIF(SUM(rp.horas_trabajadas) + SUM(rp.horas_no_trabajadas), 0)) * 100,\r\n    2\r\n  ) AS eficiencia_porcentual\r\nFROM RegistrosProduccion AS rp\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario\r\nWHERE\r\n  -- Filtros de máquina y operario (incluyendo registros NULL/Sin Asignar)\r\n  COALESCE(m.nombre, 'Sin Asignar') IN ($maquina)\r\n  AND COALESCE(o.nombre, 'Sin Asignar') IN ($operario)\r\n  -- Filtro de año (incluyendo registros NULL/Sin Asignar)\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Indicador de eficiencia global",
      "type": "gauge"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "barWidthFactor": 0.6,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "insertNulls": false,
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "showValues": false,
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 11,
        "w": 12,
        "x": 0,
        "y": 14
      },
      "id": 3,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "postgres",
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "ef3qa71ynn6kgc"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT \r\n    fecha,\r\n    SUM(pacas_producidas) AS total_pacas\r\nFROM RegistrosProduccion\r\nGROUP BY fecha\r\nORDER BY fecha;",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Monitoreo Producción Diaria",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 74,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 0,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 19,
        "w": 12,
        "x": 12,
        "y": 17
      },
      "id": 2,
      "options": {
        "barRadius": 0.05,
        "barWidth": 0.5,
        "colorByField": "total_pacas",
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "orientation": "horizontal",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "postgres",
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "ef3qa71ynn6kgc"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  COALESCE(o.nombre, 'Sin Asignar') AS operario, -- <--- CAMBIO AQUÍ\r\n  SUM(rp.pacas_producidas) AS total_pacas\r\nFROM RegistrosProduccion AS rp\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina\r\nWHERE\r\n  -- Filtro de máquina\r\n  COALESCE(m.nombre, 'Sin Asignar') IN ($maquina)\r\n  -- Filtro de año\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)\r\nGROUP BY COALESCE(o.nombre, 'Sin Asignar') -- <--- CAMBIO AQUÍ\r\nORDER BY total_pacas DESC;",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [
                  {
                    "name": "operario_id",
                    "type": "functionParameter"
                  }
                ],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          },
          "table": "registrosproduccion"
        }
      ],
      "title": "Producción por operario",
      "type": "barchart"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 25
      },
      "id": 1,
      "options": {
        "barRadius": 0,
        "barWidth": 0.76,
        "colorByField": "maquina",
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xField": "maquina",
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "postgres",
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "ef3qa71ynn6kgc"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  -- Usamos COALESCE para manejar el caso de máquinas NULL\r\n  -- aunque en este caso es menos probable si estás haciendo un JOIN a Maquinas.\r\n  -- Dejo el JOIN, pero añado el COALESCE para Operario y Año.\r\n  m.nombre AS maquina,\r\n  SUM(rp.pacas_producidas) AS total_pacas\r\nFROM RegistrosProduccion AS rp\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina -- Usamos LEFT JOIN para no perder registros si Maquina_ID fuera NULL\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario\r\nWHERE\r\n  -- Filtro de operario\r\n  COALESCE(o.nombre, 'Sin Asignar') IN ($operario)\r\n  -- Filtro de año\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)\r\nGROUP BY m.nombre -- Agrupamos por el nombre de la máquina\r\nORDER BY total_pacas DESC;",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Pacas producidas por maquina",
      "type": "barchart"
    },
    {
      "fieldConfig": {
        "defaults": {},
        "overrides": []
      },
      "gridPos": {
        "h": 2,
        "w": 24,
        "x": 0,
        "y": 36
      },
      "id": 7,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "<center>\r\n  DETALLES PAROS DE PRODUCCIÓN\r\n</center> ",
        "mode": "html"
      },
      "pluginVersion": "12.2.1",
      "title": "",
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "horas_no_trabajadas"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "red",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 38
      },
      "id": 10,
      "options": {
        "barRadius": 0,
        "barWidth": 0.97,
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "right",
          "showLegend": true
        },
        "orientation": "auto",
        "showValue": "never",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "postgres",
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "ef3qa71ynn6kgc"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  COALESCE(m.nombre, 'Sin Asignar') AS maquina, -- <--- Etiquetar NULLs\r\n  SUM(rp.horas_trabajadas) AS horas_trabajadas,\r\n  SUM(rp.horas_no_trabajadas) AS horas_no_trabajadas\r\nFROM RegistrosProduccion AS rp\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina -- LEFT JOIN para mantener registros sin máquina_id\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario -- Añadimos JOIN a Operarios para poder filtrar\r\nWHERE\r\n  -- Filtro de operario\r\n  COALESCE(o.nombre, 'Sin Asignar') IN ($operario)\r\n  -- Filtro de año\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)\r\nGROUP BY COALESCE(m.nombre, 'Sin Asignar') -- <--- Agrupar por la expresión COALESCE\r\nORDER BY maquina; -- Ordenar por el alias",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Horas trabajadas vs No trabajadas (por máquina)",
      "type": "barchart"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 80,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 38
      },
      "id": 9,
      "options": {
        "barRadius": 0,
        "barWidth": 0.83,
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "table",
          "placement": "bottom",
          "showLegend": false
        },
        "orientation": "auto",
        "showValue": "auto",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "postgres",
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "ef3qa71ynn6kgc"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  -- Usamos COALESCE para manejar áreas nulas si las hay\r\n  COALESCE(dpp.area_involucrada, 'Sin Asignar') AS area_involucrada,\r\n  SUM(dpp.horas_paro) AS total_horas\r\nFROM DetalleParosProduccion AS dpp\r\n-- 1. Unir con la tabla de registros principal (Hechos)\r\nLEFT JOIN RegistrosProduccion AS rp ON dpp.registro_id = rp.id_registro\r\n-- 2. Unir con las dimensiones para poder filtrar\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario\r\nWHERE\r\n  -- Filtro de máquina (COALESCE maneja NULLs)\r\n  COALESCE(m.nombre, 'Sin Asignar') IN ($maquina)\r\n  -- Filtro de operario (COALESCE maneja NULLs)\r\n  AND COALESCE(o.nombre, 'Sin Asignar') IN ($operario)\r\n  -- Filtro de año (COALESCE maneja NULLs)\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)\r\nGROUP BY COALESCE(dpp.area_involucrada, 'Sin Asignar')\r\nORDER BY total_horas DESC;",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Paros por área involucrada",
      "type": "barchart"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            },
            "footer": {
              "reducers": []
            },
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 24,
        "x": 0,
        "y": 46
      },
      "id": 8,
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "postgres",
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "ef3qa71ynn6kgc"
          },
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  r.fecha,\r\n  m.nombre AS maquina,\r\n  d.codigo_paro,\r\n  d.horas_paro,\r\n  d.area_involucrada,\r\n  d.personal_involucrado,\r\n  d.observaciones_paro\r\nFROM detalleparosproduccion d\r\nJOIN registrosproduccion r ON d.registro_id = r.id_registro\r\nJOIN maquinas m ON r.maquina_id = m.id_maquina\r\nORDER BY r.fecha DESC\r\nLIMIT 20;\r\n",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Detalle de los últimos paros",
      "type": "table"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisBorderShow": false,
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "fillOpacity": 64,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineWidth": 1,
            "scaleDistribution": {
              "type": "linear"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 14,
        "w": 11,
        "x": 0,
        "y": 55
      },
      "id": 12,
      "options": {
        "barRadius": 0,
        "barWidth": 0.5,
        "fullHighlight": false,
        "groupWidth": 0.7,
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "right",
          "showLegend": true
        },
        "orientation": "horizontal",
        "showValue": "never",
        "stacking": "none",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        },
        "xTickLabelRotation": 0,
        "xTickLabelSpacing": 0
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "produccion_db",
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  -- 1. Combina Mes y Año para una etiqueta única (Ej: Enero 2024)\r\n  rp.mes || ' ' || CAST(rp.año AS VARCHAR) AS \"mes_anual\",\r\n  -- 2. Calcula la eficiencia porcentual total para ese periodo Mes/Año\r\n  ROUND(\r\n    (SUM(rp.horas_trabajadas) / (SUM(rp.horas_trabajadas) + SUM(rp.horas_no_trabajadas))) * 100,\r\n    2\r\n  ) AS \"eficiencia_porcentual\"\r\nFROM RegistrosProduccion AS rp\r\n-- Uniones para poder aplicar los filtros\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario\r\nWHERE\r\n  -- Paso 1: Excluye registros donde MES o AÑO son NULL\r\n  rp.mes IS NOT NULL\r\n  AND rp.año IS NOT NULL\r\n  -- Paso 2: Filtro de máquina (incluye NULLs/Sin Asignar)\r\n  AND COALESCE(m.nombre, 'Sin Asignar') IN ($maquina)\r\n  -- Paso 3: Filtro de operario (incluye NULLs/Sin Asignar)\r\n  AND COALESCE(o.nombre, 'Sin Asignar') IN ($operario)\r\n  -- Paso 4: Filtro de año (incluye NULLs/Sin Asignar)\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)\r\nGROUP BY rp.mes, rp.año\r\n-- Paso 5: FILTRAR EL RESULTADO FINAL (HAVING)\r\nHAVING \r\n    -- 5a. Asegura que el tiempo total de reporte no sea cero (Evita división por cero)\r\n    (SUM(rp.horas_trabajadas) + SUM(rp.horas_no_trabajadas)) > 0\r\n    -- 5b. Asegura que la eficiencia sea mayor a 0 (si solo hay horas_no_trabajadas la eficiencia es 0)\r\n    AND SUM(rp.horas_trabajadas) > 0 \r\nORDER BY \"eficiencia_porcentual\" DESC;",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Porcentaje de eficiencia (horas trabajadas)",
      "type": "barchart"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "continuous-GrYlRd"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 9,
        "w": 13,
        "x": 11,
        "y": 55
      },
      "id": 14,
      "options": {
        "displayMode": "basic",
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "maxVizHeight": 300,
        "minVizHeight": 16,
        "minVizWidth": 8,
        "namePlacement": "auto",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "showUnfilled": true,
        "sizing": "auto",
        "valueMode": "color"
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "produccion_db",
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  -- 1. Agrupación por Tipo de Paro (etiquetando nulos como 'Sin Clasificar')\r\n  COALESCE(dpp.tipo_paro, 'Sin Clasificar') AS \"Tipo_de_Paro\",\r\n  -- 2. Suma total de las horas de paro\r\n  SUM(dpp.horas_paro) AS \"Total_Horas_Paro\"\r\nFROM DetalleParosProduccion AS dpp\r\n-- Unir con RegistrosProduccion para acceder a los filtros\r\nLEFT JOIN RegistrosProduccion AS rp ON dpp.registro_id = rp.id_registro\r\n-- Unir con las dimensiones para los filtros de Grafana\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario\r\nWHERE\r\n  -- Asegurar que las horas de paro sean positivas\r\n  dpp.horas_paro IS NOT NULL AND dpp.horas_paro > 0\r\n  -- Aplicar filtros de Grafana y manejar nulos\r\n  AND COALESCE(m.nombre, 'Sin Asignar') IN ($maquina)\r\n  AND COALESCE(o.nombre, 'Sin Asignar') IN ($operario)\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)\r\nGROUP BY 1\r\nORDER BY \"Total_Horas_Paro\" DESC;",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Horas de Paro por Tipo",
      "type": "bargauge"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "auto"
            },
            "footer": {
              "reducers": []
            },
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 13,
        "w": 13,
        "x": 11,
        "y": 64
      },
      "id": 13,
      "options": {
        "cellHeight": "sm",
        "showHeader": true
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "produccion_db",
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  -- 1. Etiqueta combinada Mes y Año (Ej: Enero 2025)\r\n  rp.mes || ' ' || CAST(rp.año AS VARCHAR) AS \"Periodo\",\r\n  -- 2. Suma total de Horas Trabajadas\r\n  SUM(rp.horas_trabajadas) AS \"Horas_Trabajadas\",\r\n  -- 3. Suma total de Horas NO Trabajadas\r\n  SUM(rp.horas_no_trabajadas) AS \"Horas_No_Trabajadas\"\r\nFROM RegistrosProduccion AS rp\r\n-- Uniones para poder aplicar los filtros\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario\r\nWHERE\r\n  -- Excluye registros donde MES o AÑO son NULL\r\n  rp.mes IS NOT NULL AND rp.año IS NOT NULL\r\n  -- Filtros de Grafana\r\n  AND COALESCE(m.nombre, 'Sin Asignar') IN ($maquina)\r\n  AND COALESCE(o.nombre, 'Sin Asignar') IN ($operario)\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)\r\nGROUP BY 1, rp.mes, rp.año -- Agrupamos por la etiqueta y sus componentes\r\nORDER BY \"Periodo\"; -- Ordena alfabéticamente (no cronológicamente)",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Horas Trabajadas vs Horas No Trabajadas",
      "type": "table"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "ef3qa71ynn6kgc"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": []
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 11,
        "x": 0,
        "y": 69
      },
      "id": 15,
      "options": {
        "displayLabels": [
          "name",
          "percent"
        ],
        "legend": {
          "calcs": [],
          "displayMode": "hidden",
          "placement": "right",
          "showLegend": false,
          "values": []
        },
        "pieType": "pie",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": true
        },
        "sort": "desc",
        "tooltip": {
          "hideZeros": false,
          "mode": "single",
          "sort": "none"
        }
      },
      "pluginVersion": "12.2.1",
      "targets": [
        {
          "dataset": "produccion_db",
          "editorMode": "code",
          "format": "table",
          "rawQuery": true,
          "rawSql": "SELECT\r\n  -- 1. Etiqueta de la máquina (incluye \"Sin Asignar\" para nulos)\r\n  COALESCE(m.nombre, 'Sin Asignar') AS \"Máquina\",\r\n  -- 2. Suma total de las horas de paro\r\n  SUM(dpp.horas_paro) AS \"Total_Horas_Paro\"\r\nFROM DetalleParosProduccion AS dpp\r\n-- 1. Unir con RegistrosProduccion para acceder a IDs de máquina y filtros\r\nLEFT JOIN RegistrosProduccion AS rp ON dpp.registro_id = rp.id_registro\r\n-- 2. Unir con la tabla Maquinas para obtener el nombre\r\nLEFT JOIN Maquinas AS m ON rp.maquina_id = m.id_maquina\r\n-- 3. Unir con Operarios para poder aplicar el filtro de operario\r\nLEFT JOIN Operarios AS o ON rp.operario_id = o.id_operario\r\nWHERE\r\n  -- Asegurar que las horas de paro sean positivas\r\n  dpp.horas_paro IS NOT NULL AND dpp.horas_paro > 0\r\n  -- Aplicar filtros de Grafana y manejar nulos\r\n  AND COALESCE(o.nombre, 'Sin Asignar') IN ($operario)\r\n  AND COALESCE(CAST(rp.año AS VARCHAR), 'Sin Asignar') IN ($anio)\r\nGROUP BY 1\r\nORDER BY \"Total_Horas_Paro\" DESC;",
          "refId": "A",
          "sql": {
            "columns": [
              {
                "parameters": [],
                "type": "function"
              }
            ],
            "groupBy": [
              {
                "property": {
                  "type": "string"
                },
                "type": "groupBy"
              }
            ],
            "limit": 50
          }
        }
      ],
      "title": "Detalle de paros por máquina",
      "type": "piechart"
    }
  ],
  "preload": false,
  "refresh": "30s",
  "schemaVersion": 42,
  "tags": [],
  "templating": {
    "list": [
      {
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "definition": "SELECT nombre FROM maquinas\nUNION ALL\nSELECT 'Sin Asignar'\nORDER BY nombre;",
        "includeAll": true,
        "name": "maquina",
        "options": [],
        "query": "SELECT nombre FROM maquinas\nUNION ALL\nSELECT 'Sin Asignar'\nORDER BY nombre;",
        "refresh": 1,
        "regex": "",
        "type": "query"
      },
      {
        "current": {
          "text": "All",
          "value": "$__all"
        },
        "definition": "SELECT nombre FROM operarios\nUNION ALL\nSELECT 'Sin Asignar'\nORDER BY nombre;",
        "includeAll": true,
        "name": "operario",
        "options": [],
        "query": "SELECT nombre FROM operarios\nUNION ALL\nSELECT 'Sin Asignar'\nORDER BY nombre;",
        "refresh": 1,
        "regex": "",
        "type": "query"
      },
      {
        "current": {
          "text": "2024",
          "value": "2024"
        },
        "definition": "SELECT DISTINCT CAST(año AS VARCHAR) FROM registrosproduccion WHERE año IS NOT NULL\nUNION ALL\nSELECT 'Sin Asignar'\nORDER BY 1;",
        "description": "",
        "includeAll": true,
        "name": "anio",
        "options": [],
        "query": "SELECT DISTINCT CAST(año AS VARCHAR) FROM registrosproduccion WHERE año IS NOT NULL\nUNION ALL\nSELECT 'Sin Asignar'\nORDER BY 1;",
        "refresh": 1,
        "regex": "",
        "type": "query"
      }
    ]
  },
  "time": {
    "from": "2020-11-09T10:27:24.196Z",
    "to": "2028-11-11T10:27:24.196Z"
  },
  "timepicker": {},
  "timezone": "browser",
  "title": "PRODUCCIÓN TEMPERAS Y VINILOS",
  "uid": "adczgct",
  "version": 31
}